<!DOCTYPE html>
<html lang="es">
<head>
    <title>M.A.I.R.A. - Planeamiento</title>
    
    <!-- FAVICON Y META -->
    <link rel="apple-touch-icon" sizes="180x180" href="/Client/image/favicon_logoai/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/Client/image/favicon_logoai/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/Client/image/favicon_logoai/favicon-16x16.png">
    <link rel="manifest" href="/Client/image/favicon_logoai/site.webmanifest">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- ESTILOS CSS -->
    <link rel="stylesheet" href="node_modules/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="node_modules/leaflet-draw/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="node_modules/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="node_modules/@raruto/leaflet-elevation/dist/leaflet-elevation.css" />
    <link rel="stylesheet" href="node_modules/leaflet-fullscreen/dist/leaflet.fullscreen.css" />
    <link rel="stylesheet" href="node_modules/leaflet-sidebar-v2/css/leaflet-sidebar.min.css" />
    <link rel="stylesheet" href="node_modules/leaflet-measure/dist/leaflet-measure.css" />
    <link rel="stylesheet" href="node_modules/leaflet-easybutton/src/easy-button.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="Client/css/planeamiento.css">
    <link rel="stylesheet" href="Client/css/CYGMarcha.css">
    <!-- <script src="/test_correcciones_especificas.js"></script> ARCHIVO NO EXISTE -->
    
    <!-- BIBLIOTECAS EXTERNAS -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="node_modules/html2canvas/dist/html2canvas.min.js"></script>
    
    <!-- MAPAS Y VISUALIZACIÓN -->
    <script src="node_modules/leaflet/dist/leaflet.js"></script>
    <script src="node_modules/milsymbol/dist/milsymbol.js"></script>
    <script src="node_modules/d3/dist/d3.min.js"></script>
    <script src="node_modules/@raruto/leaflet-elevation/dist/leaflet-elevation.min.js"></script>
    <script src="node_modules/leaflet-draw/dist/leaflet.draw.js"></script>
    <script src="node_modules/leaflet-geometryutil/src/leaflet.geometryutil.js"></script>
    <script src="node_modules/leaflet-geosearch/dist/bundle.min.js"></script>
    <script src="node_modules/geotiff/dist-browser/geotiff.js"></script>
    <script src="node_modules/leaflet-control-geocoder/dist/Control.Geocoder.min.js"></script>
    <script src="node_modules/proj4/dist/proj4.js"></script>
    <script src="node_modules/leaflet-utfgrid/dist/leaflet.utfgrid.js"></script>
    <script src="node_modules/mgrs/mgrs.js"></script>
    <script src="node_modules/leaflet.gridlayer.googlemutant/dist/Leaflet.GoogleMutant.js"></script>
    <script src="node_modules/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="node_modules/leaflet-fullscreen/dist/Leaflet.fullscreen.min.js"></script>
    <script src="node_modules/leaflet-sidebar-v2/js/leaflet-sidebar.min.js"></script>
    <script src="node_modules/leaflet-measure/dist/leaflet-measure.js"></script>
    <script src="node_modules/leaflet-easybutton/src/easy-button.js"></script>
    
    <!-- 🌍 HANDLERS MAIRA 4.0 OPTIMIZADOS -->
    <script src="Client/js/handlers/elevationHandler.js"></script>
    <script src="Client/js/handlers/vegetacionhandler.js"></script>
    <script src="Client/js/handlers/transitabilidadHandler.js"></script>
    <script src="Client/js/handlers/pendienteHandler.js"></script>
    <script src="Client/js/handlers/performanceOptimizer.js"></script>
    
    <!-- 🚀 SERVICIOS 3D -->
    <script src="Client/js/services/threeDMapService.js"></script>
    <script src="Client/js/services/slopeAnalysisService.js"></script>
    
    <!-- ⚡ WORKERS OPTIMIZADOS -->
    <script src="Client/js/workers/vegetation.worker.js"></script>
    <script src="Client/js/workers/elevation.worker.js"></script>
    
    <!-- 🎯 UTILIDADES -->
    <script src="Client/js/utils/mini_tiles_loader.js"></script>
    <script src="Client/js/utils/utilsGB.js"></script>
    <script src="Client/js/utils/calcosP.js"></script>
    
    <!-- 📡 CORE MAIRA -->
    <script src="Client/js/handlers/EventBus.js"></script>
    <script src="Client/js/handlers/UserIdentityLoader.js"></script>
    <script src="/Client/js/handlers/sessionManager.js"></script>
    
    <!-- 🎮 PLANEAMIENTO ESPECÍFICO -->
    <script src="/Client/js/handlers/planeamiento.js"></script>
    <script src="/Client/js/handlers/graficoMarcha.js"></script>
    <script src="/Client/js/handlers/panelMarcha.js"></script>
    <script src="/Client/js/handlers/simbolosP.js"></script>
    <script src="/Client/js/handlers/mapaP.js"></script>
    <script src="/Client/js/handlers/herramientasP.js"></script>
    <script src="/Client/js/handlers/indexP.js"></script>
    <script src="/Client/js/handlers/atajosP.js"></script>
    
    <style>
        /* 🎨 ESTILOS PLANEAMIENTO INTEGRADO */
        .maira-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #1a1a1a, #2d3748);
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .maira-header {
            height: 60px;
            background: linear-gradient(90deg, #2b6cb0, #3182ce);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .maira-title {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 0;
        }
        
        .maira-controls {
            display: flex;
            gap: 10px;
        }
        
        .maira-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .maira-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }
        
        .maira-main {
            flex: 1;
            display: flex;
            position: relative;
        }
        
        .maira-sidebar {
            width: 350px;
            background: linear-gradient(180deg, #2d3748, #1a202c);
            border-right: 1px solid #4a5568;
            overflow-y: auto;
            transition: width 0.3s;
        }
        
        .maira-sidebar.collapsed {
            width: 60px;
        }
        
        .maira-map-container {
            flex: 1;
            position: relative;
        }
        
        .toggle-3d-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        
        .toggle-3d-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        .status-bar {
            height: 30px;
            background: #1a202c;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 12px;
            border-top: 1px solid #4a5568;
        }
        
        .status-item {
            margin-right: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
        }
        
        .status-indicator.warning {
            background: #ed8936;
        }
        
        .status-indicator.error {
            background: #f56565;
        }
        
        /* NOTIFICACIONES MEJORADAS */
        .maira-notifications {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }
        
        .maira-notification {
            background: linear-gradient(135deg, #4a5568, #2d3748);
            border: 1px solid #718096;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            .maira-sidebar {
                position: absolute;
                left: -350px;
                z-index: 1000;
                height: 100%;
            }
            
            .maira-sidebar.open {
                left: 0;
            }
            
            .toggle-3d-btn {
                top: 10px;
                right: 10px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <div class="maira-container">
        <!-- HEADER INTEGRADO -->
        <div class="maira-header">
            <h1 class="maira-title">
                <i class="fas fa-drafting-compass"></i>
                MAIRA 4.0 - Planeamiento Integrado
            </h1>
            
            <div class="maira-controls">
                <button class="maira-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <button class="maira-btn" onclick="togglePerformanceMode()">
                    <i class="fas fa-tachometer-alt"></i> Performance
                </button>
                <button class="maira-btn" onclick="exportPlan()">
                    <i class="fas fa-download"></i> Exportar
                </button>
                <button class="maira-btn" onclick="showHelp()">
                    <i class="fas fa-question-circle"></i>
                </button>
            </div>
        </div>
        
        <!-- CONTENIDO PRINCIPAL -->
        <div class="maira-main">
            <!-- SIDEBAR INTEGRADO -->
            <div class="maira-sidebar" id="sidebar">
                <!-- El contenido del sidebar se mantendrá igual que en los originales -->
                <div id="sidebar" class="leaflet-sidebar collapsed">
                    <!-- Tabs -->
                    <div class="leaflet-sidebar-tabs">
                        <ul role="tablist">
                            <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
                            <li><a href="#profile" role="tab"><i class="fa fa-user"></i></a></li>
                            <li><a href="#messages" role="tab"><i class="fa fa-envelope"></i></a></li>
                            <li><a href="#configuracion" role="tab"><i class="fa fa-cog"></i></a></li>
                            <li><a href="#medicion" role="tab"><i class="fa fa-map"></i></a></li>
                            <li><a href="#dibujos" role="tab"><i class="fa fa-edit"></i></a></li>
                            <li><a href="#simbolos" role="tab"><i class="fa fa-map-marker"></i></a></li>
                            <li><a href="#Marcha" role="tab"><i class="fa fa-chart-bar"></i></a></li>
                            <li><a href="#herramientas" role="tab"><i class="fa fa-wrench"></i></a></li>
                            <li><a href="#ayuda" role="tab"><i class="fa fa-question"></i></a></li>
                        </ul>
                        <ul role="tablist">
                            <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
                        </ul>
                    </div>
                    
                    <!-- Panels -->
                    <div class="leaflet-sidebar-content">
                        <div class="leaflet-sidebar-pane" id="home">
                            <h1 class="leaflet-sidebar-header">MAIRA 4.0<span class="leaflet-sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
                            <div class="welcome-container">
                                <h2>Bienvenido al Sistema MAIRA</h2>
                                <p>Sistema Militar Argentino de Inteligencia, Reconocimiento y Apoyo</p>
                                
                                <div class="quick-actions">
                                    <h3>Acciones Rápidas</h3>
                                    <button class="action-btn" onclick="iniciarNuevoPlaneamiento()">
                                        <i class="fas fa-plus"></i> Nuevo Planeamiento
                                    </button>
                                    <button class="action-btn" onclick="cargarPlaneamiento()">
                                        <i class="fas fa-folder-open"></i> Cargar Planeamiento
                                    </button>
                                    <button class="action-btn" onclick="activarModo3D()">
                                        <i class="fas fa-cube"></i> Vista 3D
                                    </button>
                                </div>
                                
                                <div class="system-status">
                                    <h3>Estado del Sistema</h3>
                                    <div class="status-grid">
                                        <div class="status-item">
                                            <span class="status-indicator"></span>
                                            <span>Elevación: Activo</span>
                                        </div>
                                        <div class="status-item">
                                            <span class="status-indicator"></span>
                                            <span>Vegetación: Activo</span>
                                        </div>
                                        <div class="status-item">
                                            <span class="status-indicator"></span>
                                            <span>3D: Disponible</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Los demás paneles se mantienen igual que en los originales -->
                        <!-- ... resto del contenido del sidebar ... -->
                    </div>
                </div>
            </div>
            
            <!-- CONTENEDOR MAPA -->
            <div class="maira-map-container">
                <div id="map" style="height: 100%;"></div>
                
                <!-- BOTÓN 3D MEJORADO -->
                <button class="toggle-3d-btn" onclick="toggle3DView()" id="btn3d">
                    <i class="fas fa-cube"></i>
                    <span>Vista 3D</span>
                </button>
            </div>
        </div>
        
        <!-- BARRA ESTADO -->
        <div class="status-bar">
            <div class="status-item">
                <span class="status-indicator" id="connection-status"></span>
                <span>Conexión</span>
            </div>
            <div class="status-item">
                <span class="status-indicator" id="elevation-status"></span>
                <span>Elevación</span>
            </div>
            <div class="status-item">
                <span class="status-indicator" id="vegetation-status"></span>
                <span>Vegetación</span>
            </div>
            <div class="status-item">
                <span class="status-indicator" id="performance-status"></span>
                <span>Performance</span>
            </div>
            <div class="status-item">
                <span id="coordinates-display">Lat: --, Lng: --</span>
            </div>
        </div>
    </div>
    
    <!-- NOTIFICACIONES -->
    <div class="maira-notifications" id="notifications-container"></div>
    
    <!-- SCRIPT PRINCIPAL INTEGRADO -->
    <script>
        /**
         * 🚀 MAIRA 4.0 - PLANEAMIENTO INTEGRADO
         * Unifica lo mejor de ambas versiones con optimizaciones CDN
         */
        
        let map;
        let sidebar;
        let threeDActive = false;
        let performanceMode = false;
        
        // INICIALIZACIÓN PRINCIPAL
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Inicializando MAIRA 4.0 Planeamiento Integrado...');
            initializeMAIRA();
        });
        
        async function initializeMAIRA() {
            try {
                // 1. Inicializar mapa base
                await initializeMap();
                
                // 2. Configurar sidebar
                initializeSidebar();
                
                // 3. Cargar servicios de datos (CDN GitHub Releases)
                await loadDataServices();
                
                // 4. Configurar eventos y controles
                setupEventHandlers();
                
                // 5. Inicializar herramientas de planeamiento
                initializePlanningTools();
                
                // 6. Mostrar notificación de éxito
                showNotification('Sistema Iniciado', 'MAIRA 4.0 Planeamiento listo para usar', 'success');
                
                updateSystemStatus();
                
            } catch (error) {
                console.error('❌ Error inicializando MAIRA:', error);
                showNotification('Error del Sistema', 'No se pudo inicializar completamente', 'error');
            }
        }
        
        async function initializeMap() {
            // Configurar mapa con Argentina como centro
            map = L.map('map', {
                center: [-34.6118, -58.3960],
                zoom: 6,
                zoomControl: true,
                attributionControl: false
            });
            
            // Capas base optimizadas
            const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'MAIRA 4.0',
                maxZoom: 18
            });
            
            const terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'MAIRA 4.0',
                maxZoom: 17
            });
            
            // Agregar capa por defecto
            satellite.addTo(map);
            
            // Control de capas
            L.control.layers({
                "Satélite": satellite,
                "Terreno": terrain
            }).addTo(map);
            
            // Controles adicionales
            L.control.scale({ metric: true, imperial: false }).addTo(map);
            
            console.log('✅ Mapa inicializado');
        }
        
        function initializeSidebar() {
            sidebar = L.control.sidebar('sidebar').addTo(map);
            console.log('✅ Sidebar inicializado');
        }
        
        async function loadDataServices() {
            console.log('🌍 Cargando servicios de datos desde GitHub Releases...');
            
            try {
                // Cargar handler de elevación (ahora apunta a GitHub Releases)
                if (window.elevationHandler) {
                    await window.elevationHandler.initialize();
                    updateStatusIndicator('elevation-status', true);
                }
                
                // Cargar handler de vegetación (ahora apunta a GitHub Releases)
                if (window.vegetacionHandler) {
                    await window.vegetacionHandler.initialize();
                    updateStatusIndicator('vegetation-status', true);
                }
                
                // Servicio 3D
                if (window.threeDMapService) {
                    await window.threeDMapService.initialize();
                }
                
                console.log('✅ Servicios de datos cargados desde CDN');
                
            } catch (error) {
                console.error('⚠️ Error cargando servicios:', error);
                showNotification('Servicios Limitados', 'Algunos servicios no están disponibles', 'warning');
            }
        }
        
        function setupEventHandlers() {
            // Eventos del mapa
            map.on('mousemove', function(e) {
                updateCoordinatesDisplay(e.latlng);
            });
            
            map.on('click', function(e) {
                // Obtener datos de elevación y vegetación en el punto clickeado
                if (window.elevationHandler) {
                    const elevation = window.elevationHandler.getElevationAtPosition(e.latlng.lat, e.latlng.lng);
                    console.log(`Elevación en ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}: ${elevation}m`);
                }
            });
            
            // Eventos de teclado
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F3') {
                    e.preventDefault();
                    toggle3DView();
                }
                if (e.key === 'F2') {
                    e.preventDefault();
                    togglePerformanceMode();
                }
            });
        }
        
        function initializePlanningTools() {
            // Cargar herramientas específicas de planeamiento
            if (typeof initializePlaneamientoTools === 'function') {
                initializePlaneamientoTools();
            }
            
            console.log('✅ Herramientas de planeamiento inicializadas');
        }
        
        // FUNCIONES DE INTERFAZ
        function toggleSidebar() {
            const sidebarElement = document.getElementById('sidebar');
            sidebarElement.classList.toggle('collapsed');
        }
        
        function toggle3DView() {
            if (window.threeDMapService) {
                window.threeDMapService.toggle();
                threeDActive = !threeDActive;
                
                const btn = document.getElementById('btn3d');
                btn.innerHTML = threeDActive ? 
                    '<i class="fas fa-map"></i><span>Vista 2D</span>' : 
                    '<i class="fas fa-cube"></i><span>Vista 3D</span>';
                
                showNotification('Vista 3D', threeDActive ? 'Activada' : 'Desactivada', 'info');
            }
        }
        
        function togglePerformanceMode() {
            performanceMode = !performanceMode;
            
            if (window.performanceOptimizer) {
                if (performanceMode) {
                    window.performanceOptimizer.enableHighPerformance();
                } else {
                    window.performanceOptimizer.enableHighQuality();
                }
            }
            
            updateStatusIndicator('performance-status', true);
            showNotification('Modo Performance', performanceMode ? 'Activado' : 'Desactivado', 'info');
        }
        
        function activarModo3D() {
            toggle3DView();
        }
        
        function iniciarNuevoPlaneamiento() {
            showNotification('Nuevo Planeamiento', 'Iniciando nuevo planeamiento...', 'info');
            // Lógica específica de planeamiento
        }
        
        function cargarPlaneamiento() {
            showNotification('Cargar Planeamiento', 'Abriendo selector de archivos...', 'info');
            // Lógica de carga
        }
        
        function exportPlan() {
            showNotification('Exportar Plan', 'Preparando exportación...', 'info');
            // Lógica de exportación
        }
        
        function showHelp() {
            showNotification('Ayuda', 'F3: Vista 3D | F2: Performance Mode', 'info');
        }
        
        // UTILIDADES
        function updateCoordinatesDisplay(latlng) {
            const coords = document.getElementById('coordinates-display');
            if (coords) {
                coords.textContent = `Lat: ${latlng.lat.toFixed(4)}, Lng: ${latlng.lng.toFixed(4)}`;
            }
        }
        
        function updateStatusIndicator(id, status) {
            const indicator = document.getElementById(id);
            if (indicator) {
                indicator.className = `status-indicator ${status ? '' : 'error'}`;
            }
        }
        
        function updateSystemStatus() {
            updateStatusIndicator('connection-status', true);
            updateStatusIndicator('elevation-status', !!window.elevationHandler);
            updateStatusIndicator('vegetation-status', !!window.vegetacionHandler);
            updateStatusIndicator('performance-status', true);
        }
        
        function showNotification(title, message, type = 'info') {
            const container = document.getElementById('notifications-container');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.className = 'maira-notification';
            notification.innerHTML = `
                <h4 style="margin: 0 0 5px 0; color: #63b3ed;">${title}</h4>
                <p style="margin: 0; font-size: 14px;">${message}</p>
            `;
            
            container.appendChild(notification);
            
            // Auto-remove después de 5 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }
        
        // EXPORTAR FUNCIONES GLOBALES
        window.MAIRA_Planeamiento = {
            map,
            toggleSidebar,
            toggle3DView,
            togglePerformanceMode,
            showNotification,
            updateSystemStatus
        };
        
        console.log('🎯 MAIRA 4.0 Planeamiento Integrado - Listo');
    </script>
</body>
</html>
